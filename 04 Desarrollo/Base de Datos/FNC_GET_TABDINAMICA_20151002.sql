--  Generate SQL --  Version:                   	V5R4M0 060210 --  Generated on:              	02/10/15 12:49:30 --  Relational Database:       	B103BE2F --  Standards Option:          	DB2 UDB iSeries   SET PATH "QSYS","QSYS2","CARVALHORA" ;   --DROP FUNCTION CARVALHORA.FNC_GET_TABDINAMICA ;CREATE FUNCTION CARVALHORA.FNC_GET_TABDINAMICA ( 	P_ID_BITACORA BIGINT, 	P_REG_OK INT, 	P_REG_OM INT, 	P_REG_ER INT ) 	RETURNS VARCHAR(2000)   	LANGUAGE SQL 	SPECIFIC CARVALHORA.FNC_GET_TABDINAMICA 	NOT DETERMINISTIC 	READS SQL DATA 	CALLED ON NULL INPUT 	DISALLOW PARALLEL 	SET OPTION  ALWBLK = *ALLREAD , 	ALWCPYDTA = *OPTIMIZE , 	COMMIT = *CHG , 	DECRESULT = (31, 31, 00) , 	DFTRDBCOL = *NONE , 	DYNDFTCOL = *NO , 	DYNUSRPRF = *USER , 	SRTSEQ = *HEX   	BEGIN ATOMIC 	 		DECLARE V_EOF INT DEFAULT 0 ; 		DECLARE V_NUM_CAM INTEGER ; 		DECLARE V_NOM_CAM VARCHAR ( 100 ) ; 		DECLARE V_CONDICION VARCHAR( 1500 ) ;		DECLARE V_SQL VARCHAR ( 2000 ) ;   		 -- Obtenci칩n de campos de la importaci칩n 		DECLARE C1 CURSOR FOR   			SELECT DISTINCT IMP_NCA , IMP_CAN 			FROM CARVALHORA . TMP_IMPO 			WHERE BII_CVE = P_ID_BITACORA 			ORDER BY IMP_CAN ASC ;   		DECLARE CONTINUE HANDLER FOR NOT FOUND 			SET V_EOF = 1 ;   		OPEN C1 ;   		 -- Estructura query en forma de tabla din치mica, de importaci칩n de archivo 		SET V_SQL = 'SELECT IMP_REN AS REG ' ;   		WHILE V_EOF = 0 DO   			FETCH FROM C1 INTO V_NOM_CAM , V_NUM_CAM ;   			IF V_EOF = 0 THEN 				SET V_SQL = V_SQL || ', MAX(CASE WHEN IMP_CAN =' || '''' || VARCHAR ( V_NUM_CAM ) || '''' || ' THEN IMP_VAL ELSE NULL END) AS C' || VARCHAR ( V_NUM_CAM ) ; 			END IF ;   		END WHILE ; 		SET V_CONDICION = '' ;		IF (P_REG_OK = 0) OR (P_REG_OM = 0) OR ( P_REG_ER = 0) THEN			IF P_REG_OK = 1 THEN 				SET V_CONDICION = V_CONDICION || ' IMP_REN IN(' 							|| ' SELECT IMP_REN '							|| ' FROM CARVALHORA . TMP_IMPO ' 							|| ' WHERE BII_CVE = ' || P_ID_BITACORA || ' ' 							|| ' GROUP BY IMP_REN '							|| ' HAVING MAX( IMP_ROK ) = 1 AND MAX(IMP_ROM) = 0 AND MAX(IMP_RER) = 0 '						       || ') ' ;			END IF ;			IF P_REG_OM = 1 THEN				SET V_CONDICION = V_CONDICION || CASE WHEN V_CONDICION = '' THEN '' ELSE ' OR ' END						      || ' IMP_REN IN('							|| ' SELECT DISTINCT IMP_REN ' 							|| ' FROM CARVALHORA . TMP_IMPO ' 							|| ' WHERE BII_CVE = ' || P_ID_BITACORA || ' AND IMP_ROM = 1 '						      || ')' ;			END IF ;			IF P_REG_ER = 1 THEN				SET V_CONDICION = V_CONDICION || CASE WHEN V_CONDICION = '' THEN '' ELSE ' OR ' END 						      || ' IMP_REN IN('							|| ' SELECT DISTINCT IMP_REN ' 							|| ' FROM CARVALHORA . TMP_IMPO ' 							|| ' WHERE BII_CVE = ' || P_ID_BITACORA || ' AND IMP_RER = 1 '						      || ')' ;			END IF ;			SET V_CONDICION = ' WHERE ' || V_CONDICION ;		END IF ;  		SET V_SQL = V_SQL || ' FROM CARVALHORA . TMP_IMPO' 			      || CASE WHEN V_CONDICION = '' THEN '' ELSE V_CONDICION END 			      || ' GROUP BY IMP_REN' 			      || ' ORDER BY IMP_REN ASC' ;   		CLOSE C1 ;   		RETURN V_SQL ; 			 	END  ;